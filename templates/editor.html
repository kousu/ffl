{% extends "_layout.html" %}

{% block content %}

<style>

html, body, #content { height: 100% }


</style>

<script src={{ url_for("static", filename="epiceditor/js/epiceditor.js") }}></script>
<script>

$(document).ready(function() {
  editor = new EpicEditor({basePath: '/static/epiceditor',
                          textarea: 'post_content',
                          button: { bar: "show" },
                          focusOnLoad: true,
                          file: { defaultContent: "# Untitled\n\n\n" },
                          theme: {preview: "themes/preview/bartik.css"}
                         }).load(); //Note: intentionally global
  // wipe localstorage: it's a nuisance that other posts can show up
  // so just ignore this feature
  // getting it to work nicely would be awesome, though:
  // work on you drafts entirely offline and then post them when you get signal, with nothing but a phone and a browser
  /*editor.remove('epiceditor'); //
  editor.open('epiceditor'); // and then we need to reopen the now-empty file
  editor.unload();
  editor.load();*/
  // since it's empty, we get the "Untitled" 

  function upload(callback) {
  }
  Upload = upload

  $("#post_button").click(function() {
    
    var msg = {content: editor.exportFile(),
		acl: $("#post_acl").val()};
    $.post("/edit/", msg, function(resp) {
      resp = JSON.parse(resp);
      if(resp.success == true) {
        console.log("Saved post"); //TODO: handle exceptions, which will come back as json I guess
        if(resp.goto != "") {
           console.log("jumping ship");
           location = resp.goto;
        }
      }
    }, "json");

    return false; // stop bubbling
  });

});

</script>


<form style="height: 100%">
<div id="epiceditor" style="width: 100%; height: 80%"></div>
<textarea id="post_content" style="display: none">{{post_content}}</textarea>
<input type=text placeholder="Aspects" id="post_acl" value="{{post_acl}}" />
<input type=date id="post_date" />
<input type=time id="post_time" />
<button id="post_button">Post</button>
{% if live_link %}
  Permalink: <a href={{ live_link }}>{{live_link}}</a>
{% endif %}

<div id="instructions">
  There is no draft-saving. Instead, set permissions to "private".<br/>
  <tt>Alt-F</tt> toggles Fullscreen<br/>
  <tt>Alt-P</tt> toggles Preview<br/>
</div>

</form>

{% endblock %}
